<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dice Toast</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=EB+Garamond:ital@0;1&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --gold: #c8a84e;
      --gold-bright: #e8d068;
      --gold-dark: #7a5a1e;
      --blood: #8b1a1a;
      --blood-bright: #cc2222;
      --mana: #4499dd;
      --bone: #d4c8a8;
      --faded: #8a7e66;
      --dim: #5a5040;
    }
    
    html, body {
      height: 100%;
      background: transparent !important;
      overflow: hidden;
      font-family: 'EB Garamond', serif;
    }
    
    #container {
      position: fixed;
      bottom: 8px;
      right: 8px;
      display: flex;
      flex-direction: column-reverse;
      gap: 8px;
      pointer-events: none;
      max-width: 320px;
    }
    
    /* ‚ïê‚ïê‚ïê Toast Card ‚ïê‚ïê‚ïê */
    .toast {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 18px;
      border-radius: 12px;
      pointer-events: auto;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(16px);
      transform-origin: right bottom;
      opacity: 0;
      transform: translateX(120%) scale(0.8) rotate(5deg);
      transition: opacity 0.4s, transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .toast.visible {
      opacity: 1;
      transform: translateX(0) scale(1) rotate(0);
    }
    
    .toast.exit {
      opacity: 0;
      transform: translateX(80%) scale(0.9);
      transition: opacity 0.3s, transform 0.3s ease-out;
    }
    
    .toast:hover {
      transform: translateX(-4px) scale(1.02) !important;
    }
    
    /* ‚ïê‚ïê‚ïê Colors ‚ïê‚ïê‚ïê */
    .toast-gold {
      background: linear-gradient(145deg, rgba(40,32,14,0.94), rgba(24,20,10,0.96));
      border: 1px solid rgba(200,168,78,0.5);
      box-shadow: 0 6px 24px rgba(0,0,0,0.5), 0 0 30px rgba(200,168,78,0.15);
    }
    
    .toast-blood {
      background: linear-gradient(145deg, rgba(40,14,14,0.94), rgba(24,10,10,0.96));
      border: 1px solid rgba(204,34,34,0.5);
      box-shadow: 0 6px 24px rgba(0,0,0,0.5), 0 0 20px rgba(204,34,34,0.15);
    }
    
    .toast-mana {
      background: linear-gradient(145deg, rgba(14,24,40,0.94), rgba(10,18,28,0.96));
      border: 1px solid rgba(68,153,221,0.5);
      box-shadow: 0 6px 24px rgba(0,0,0,0.5), 0 0 20px rgba(68,153,221,0.15);
    }
    
    .toast-green {
      background: linear-gradient(145deg, rgba(14,40,14,0.94), rgba(10,24,10,0.96));
      border: 1px solid rgba(68,204,68,0.5);
      box-shadow: 0 6px 24px rgba(0,0,0,0.5), 0 0 20px rgba(68,204,68,0.15);
    }
    
    .toast-purple {
      background: linear-gradient(145deg, rgba(32,14,40,0.94), rgba(20,10,26,0.96));
      border: 1px solid rgba(150,80,220,0.5);
      box-shadow: 0 6px 24px rgba(0,0,0,0.5), 0 0 20px rgba(150,80,220,0.15);
    }
    
    .toast-white {
      background: linear-gradient(145deg, rgba(32,32,36,0.94), rgba(20,20,24,0.96));
      border: 1px solid rgba(200,190,170,0.3);
      box-shadow: 0 6px 24px rgba(0,0,0,0.5);
    }
    
    /* ‚ïê‚ïê‚ïê Crit Effects ‚ïê‚ïê‚ïê */
    .toast-crit {
      border-color: var(--gold) !important;
      box-shadow: 0 6px 24px rgba(0,0,0,0.5), 0 0 50px rgba(232,208,104,0.3), inset 0 0 30px rgba(232,208,104,0.08) !important;
      animation: crit-entrance 0.6s ease-out;
    }
    
    @keyframes crit-entrance {
      0% { transform: translateX(150%) scale(0.4) rotate(15deg); filter: brightness(2.5); }
      50% { transform: translateX(-10px) scale(1.1) rotate(-3deg); filter: brightness(1.5); }
      100% { transform: translateX(0) scale(1) rotate(0); filter: brightness(1); }
    }
    
    .toast-crit::before {
      content: '';
      position: absolute;
      inset: -200%;
      background: conic-gradient(from 0deg, transparent, rgba(232,208,104,0.1) 5deg, transparent 10deg, transparent 20deg, rgba(232,208,104,0.08) 25deg, transparent 30deg);
      animation: rays-spin 8s linear infinite;
      pointer-events: none;
    }
    
    @keyframes rays-spin { to { transform: rotate(360deg); } }
    
    /* ‚ïê‚ïê‚ïê Fail Effects ‚ïê‚ïê‚ïê */
    .toast-fail {
      border-color: var(--blood-bright) !important;
      animation: fail-shake 0.5s ease-out;
    }
    
    @keyframes fail-shake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-8px); }
      40% { transform: translateX(8px); }
      60% { transform: translateX(-5px); }
      80% { transform: translateX(3px); }
    }
    
    /* ‚ïê‚ïê‚ïê Icon ‚ïê‚ïê‚ïê */
    .toast-icon {
      font-size: 32px;
      flex-shrink: 0;
      line-height: 1;
      filter: drop-shadow(0 3px 6px rgba(0,0,0,0.5));
      animation: icon-pop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s both;
    }
    
    @keyframes icon-pop {
      0% { transform: scale(0) rotate(-45deg); opacity: 0; }
      100% { transform: scale(1) rotate(0); opacity: 1; }
    }
    
    .toast-crit .toast-icon {
      font-size: 38px;
      filter: drop-shadow(0 0 15px rgba(232,208,104,0.8));
      animation: icon-crit-pop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) both;
    }
    
    @keyframes icon-crit-pop {
      0% { transform: scale(0) rotate(-180deg); }
      50% { transform: scale(1.4) rotate(20deg); }
      100% { transform: scale(1) rotate(0); }
    }
    
    /* ‚ïê‚ïê‚ïê Body ‚ïê‚ïê‚ïê */
    .toast-body { flex: 1; min-width: 0; }
    
    .toast-unit {
      font-family: 'Cinzel', serif;
      font-size: 10px;
      font-weight: 700;
      color: var(--faded);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-bottom: 2px;
      animation: text-slide 0.3s ease-out 0.1s both;
    }
    
    .toast-title {
      font-family: 'Cinzel', serif;
      font-size: 15px;
      font-weight: 700;
      color: var(--bone);
      line-height: 1.2;
      animation: text-slide 0.3s ease-out 0.15s both;
    }
    
    .toast-crit .toast-title {
      color: var(--gold-bright);
      text-shadow: 0 0 15px rgba(232,208,104,0.6);
      font-size: 17px;
    }
    
    .toast-fail .toast-title {
      color: var(--blood-bright);
      text-shadow: 0 0 10px rgba(204,34,34,0.5);
    }
    
    .toast-subtitle {
      font-size: 12px;
      color: var(--faded);
      font-style: italic;
      margin-top: 3px;
      animation: text-slide 0.3s ease-out 0.2s both;
    }
    
    @keyframes text-slide {
      from { opacity: 0; transform: translateX(-15px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    /* ‚ïê‚ïê‚ïê Dice ‚ïê‚ïê‚ïê */
    .toast-rolls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 5px;
      margin-top: 8px;
    }
    
    .toast-die {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 28px;
      height: 28px;
      padding: 0 5px;
      border-radius: 5px;
      font-family: 'Cinzel', serif;
      font-weight: 900;
      font-size: 13px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(200,190,170,0.2);
      color: var(--bone);
      animation: die-pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) both;
    }
    
    .toast-die:nth-child(1) { animation-delay: 0.2s; }
    .toast-die:nth-child(2) { animation-delay: 0.25s; }
    .toast-die:nth-child(3) { animation-delay: 0.3s; }
    .toast-die:nth-child(4) { animation-delay: 0.35s; }
    .toast-die:nth-child(5) { animation-delay: 0.4s; }
    
    @keyframes die-pop {
      0% { opacity: 0; transform: scale(0) rotate(-30deg); }
      100% { opacity: 1; transform: scale(1) rotate(0); }
    }
    
    .toast-die-crit {
      background: linear-gradient(135deg, rgba(200,168,78,0.4), rgba(200,168,78,0.2)) !important;
      border-color: var(--gold) !important;
      color: var(--gold-bright) !important;
      box-shadow: 0 0 12px rgba(200,168,78,0.5);
      animation: die-crit-pop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) both !important;
    }
    
    @keyframes die-crit-pop {
      0% { transform: scale(0) rotate(-180deg); }
      50% { transform: scale(1.5) rotate(30deg); box-shadow: 0 0 30px rgba(200,168,78,1); }
      100% { transform: scale(1) rotate(0); }
    }
    
    .toast-die-fail {
      background: rgba(204,34,34,0.3) !important;
      border-color: var(--blood-bright) !important;
      color: var(--blood-bright) !important;
    }
    
    .toast-eq {
      color: var(--dim);
      font-size: 14px;
      margin: 0 3px;
      animation: fade-in 0.2s ease-out 0.5s both;
    }
    
    .toast-total {
      font-family: 'Cinzel', serif;
      font-size: 22px;
      font-weight: 900;
      color: var(--bone);
      text-shadow: 0 2px 4px rgba(0,0,0,0.6);
      animation: total-pop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) 0.45s both;
    }
    
    @keyframes total-pop {
      0% { opacity: 0; transform: scale(0.3); }
      60% { transform: scale(1.3); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    .toast-crit .toast-total {
      color: var(--gold-bright) !important;
      text-shadow: 0 0 20px rgba(232,208,104,0.7);
      font-size: 26px;
    }
    
    .toast-fail .toast-total {
      color: var(--blood-bright) !important;
    }
    
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    
    /* ‚ïê‚ïê‚ïê HP Bar ‚ïê‚ïê‚ïê */
    .toast-hp {
      position: relative;
      height: 14px;
      border-radius: 7px;
      overflow: hidden;
      margin-top: 10px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .toast-hp-fill {
      position: absolute;
      left: 0; top: 0; bottom: 0;
      border-radius: 7px;
      transition: width 0.6s ease;
    }
    
    .toast-hp-dmg { background: linear-gradient(90deg, #cc2222, #881414); }
    .toast-hp-heal { background: linear-gradient(90deg, #22cc44, #118822); }
    
    .toast-hp-txt {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Cinzel', serif;
      font-size: 10px;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 1px 3px rgba(0,0,0,0.9);
    }
    
    /* ‚ïê‚ïê‚ïê Banner ‚ïê‚ïê‚ïê */
    .toast-banner {
      text-align: center;
      font-family: 'Cinzel', serif;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      padding: 8px 0 2px;
      margin-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .toast-banner-crit {
      color: var(--gold-bright);
      text-shadow: 0 0 15px rgba(232,208,104,0.7);
      animation: banner-flash 0.8s ease-out;
    }
    
    @keyframes banner-flash {
      0% { opacity: 0; letter-spacing: 0.5em; }
      30% { opacity: 1; text-shadow: 0 0 40px rgba(232,208,104,1); }
      100% { letter-spacing: 0.2em; }
    }
    
    .toast-banner-fail {
      color: var(--blood-bright);
      text-shadow: 0 0 10px rgba(204,34,34,0.6);
    }
    
    /* ‚ïê‚ïê‚ïê Progress Bar ‚ïê‚ïê‚ïê */
    .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--gold-dark), var(--gold));
      width: 100%;
      transform-origin: left;
      animation: progress-shrink 4s linear forwards;
      opacity: 0.6;
    }
    
    @keyframes progress-shrink { from { transform: scaleX(1); } to { transform: scaleX(0); } }
    
    .toast-crit .toast-progress {
      background: linear-gradient(90deg, var(--gold), var(--gold-bright));
      opacity: 0.9;
      height: 4px;
    }
    
    .toast-fail .toast-progress {
      background: linear-gradient(90deg, var(--blood), var(--blood-bright));
    }
    
    /* ‚ïê‚ïê‚ïê Decorative Runes ‚ïê‚ïê‚ïê */
    .toast-rune {
      position: absolute;
      font-size: 16px;
      color: var(--gold);
      opacity: 0;
      pointer-events: none;
      animation: rune-float 2s ease-out forwards;
    }
    
    @keyframes rune-float {
      0% { opacity: 0; transform: translateY(0) scale(0.5); }
      20% { opacity: 0.6; }
      100% { opacity: 0; transform: translateY(-40px) scale(1); }
    }
  </style>
</head>
<body>
  <div id="container"></div>
  
  <script src="https://cdn.jsdelivr.net/npm/@owlbear-rodeo/sdk@3.1.0/dist/owlbear-rodeo-sdk.umd.min.js"></script>
  <script>
    const CHANNEL = 'cursed-hearts/dice-rich';
    const container = document.getElementById('container');
    const DURATION = 4000;
    const processedIds = new Set();
    
    const ICONS = {
      roll: 'üé≤', damage: 'üí•', hit: 'üéØ', miss: 'üí®',
      spell: '‚ú®', heal: 'üíö', death: '‚ò†Ô∏è', 'rok-card': 'üÉè', custom: 'üì¢'
    };
    
    const RUNES = ['·ö±', '·õü', '·ö∫', '·õâ', '·ö¶', '·õä', '·õè', '·öπ'];
    
    function createToast(msg) {
      if (processedIds.has(msg.id)) return;
      processedIds.add(msg.id);
      
      const colorClass = 'toast-' + (msg.color || 'white');
      const isCrit = msg.isCrit;
      const isFail = msg.isCritFail;
      
      const el = document.createElement('div');
      el.className = 'toast ' + colorClass + (isCrit ? ' toast-crit' : '') + (isFail ? ' toast-fail' : '');
      
      // Icon
      let icon = msg.icon || ICONS[msg.type] || 'üé≤';
      if (isCrit) icon = '‚ú®';
      if (isFail) icon = 'üíÄ';
      
      let html = '<span class="toast-icon">' + icon + '</span>';
      html += '<div class="toast-body">';
      
      if (msg.unitName) {
        html += '<div class="toast-unit">' + msg.unitName + '</div>';
      }
      
      html += '<div class="toast-title">' + msg.title + '</div>';
      
      if (msg.subtitle) {
        html += '<div class="toast-subtitle">' + msg.subtitle + '</div>';
      }
      
      // Dice rolls
      if (msg.rolls && msg.rolls.length > 0) {
        html += '<div class="toast-rolls">';
        const maxDice = Math.min(msg.rolls.length, 6);
        for (let i = 0; i < maxDice; i++) {
          const r = msg.rolls[i];
          let dieClass = 'toast-die';
          if (i === 0 && r === 20) dieClass += ' toast-die-crit';
          if (i === 0 && r === 1) dieClass += ' toast-die-fail';
          html += '<span class="' + dieClass + '">' + r + '</span>';
        }
        if (msg.rolls.length > 6) {
          html += '<span class="toast-die">+' + (msg.rolls.length - 6) + '</span>';
        }
        if (msg.total !== undefined) {
          html += '<span class="toast-eq">=</span>';
          html += '<span class="toast-total">' + msg.total + '</span>';
        }
        html += '</div>';
      }
      
      // HP bar
      if (msg.hpBar) {
        const pct = Math.max(0, Math.min(100, (msg.hpBar.current / msg.hpBar.max) * 100));
        const fillClass = msg.type === 'heal' ? 'toast-hp-heal' : 'toast-hp-dmg';
        html += '<div class="toast-hp">';
        html += '<div class="toast-hp-fill ' + fillClass + '" style="width: ' + pct + '%"></div>';
        html += '<span class="toast-hp-txt">' + msg.hpBar.current + '/' + msg.hpBar.max + '</span>';
        html += '</div>';
      }
      
      html += '</div>'; // .toast-body
      
      // Crit/Fail banner
      if (isCrit) {
        html += '<div class="toast-banner toast-banner-crit">‚ú® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–°–ü–ï–• ‚ú®</div>';
      }
      if (isFail) {
        html += '<div class="toast-banner toast-banner-fail">üíÄ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–û–í–ê–õ</div>';
      }
      
      // Progress bar
      html += '<div class="toast-progress"></div>';
      
      el.innerHTML = html;
      container.appendChild(el);
      
      // Add floating runes for spells/crits
      if (msg.type === 'spell' || isCrit) {
        addFloatingRunes(el);
      }
      
      // Trigger visible animation
      requestAnimationFrame(() => {
        setTimeout(() => el.classList.add('visible'), 20);
      });
      
      // Click to dismiss
      el.onclick = () => removeToast(el);
      
      // Auto remove
      setTimeout(() => removeToast(el), DURATION);
    }
    
    function removeToast(el) {
      if (el.classList.contains('exit')) return;
      el.classList.remove('visible');
      el.classList.add('exit');
      setTimeout(() => el.remove(), 400);
    }
    
    function addFloatingRunes(el) {
      for (let i = 0; i < 3; i++) {
        setTimeout(() => {
          const rune = document.createElement('span');
          rune.className = 'toast-rune';
          rune.textContent = RUNES[Math.floor(Math.random() * RUNES.length)];
          rune.style.left = (20 + Math.random() * 60) + '%';
          rune.style.top = (60 + Math.random() * 20) + '%';
          rune.style.animationDelay = (Math.random() * 0.3) + 's';
          el.appendChild(rune);
          setTimeout(() => rune.remove(), 2000);
        }, i * 200);
      }
    }
    
    // Initialize OBR
    OBR.onReady(() => {
      console.log('[Toast] OBR Ready, subscribing to:', CHANNEL);
      
      OBR.broadcast.onMessage(CHANNEL, (event) => {
        console.log('[Toast] Received:', event.data);
        if (event.data && event.data.id) {
          createToast(event.data);
        }
      });
    });
  </script>
</body>
</html>
