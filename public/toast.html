<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dice Toast</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=EB+Garamond:ital,wght@0,400&display=swap" rel="stylesheet">
  <style>
    /* –ë–∞–∑–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Å–±—Ä–æ—Å */
    :root {
      --color-abyss: #0a0a0f;
      --color-obsidian: #1a1a24;
      --color-bone: #d4c8a8;
      --color-faded: #8a7e66;
      --color-dim: #5a5040;
      --color-gold: #c8a84e;
      --color-gold-bright: #e8d068;
      --color-gold-dark: #7a5a1e;
      --color-blood: #8b1a1a;
      --color-blood-bright: #cc2222;
      --color-mana-bright: #4499dd;
      --color-ancient: #7a6a4a;
      --font-cinzel: 'Cinzel', serif;
      --font-garamond: 'EB Garamond', serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      margin: 0;
      font-family: var(--font-garamond);
      background: transparent;
      color: var(--color-bone);
      overflow: hidden;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    .toast-container {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column-reverse;
      align-items: flex-end;
      padding: 8px;
      gap: 8px;
      pointer-events: none;
    }

    /* Toast –∫–∞—Ä—Ç–æ—á–∫–∞ */
    .toast {
      width: 100%;
      max-width: 320px;
      border-radius: 12px;
      padding: 12px 16px;
      position: relative;
      overflow: hidden;
      pointer-events: auto;
      cursor: pointer;
      backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.08);
      transition: transform 0.2s;
    }

    .toast:hover { transform: scale(1.02) translateX(-4px); }
    
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    .toast-enter {
      opacity: 0;
      transform: translateX(120%) scale(0.7);
    }
    
    .toast-visible {
      opacity: 1;
      transform: translateX(0) scale(1);
      transition: opacity 0.5s ease-out, transform 0.6s ease-out;
    }
    
    .toast-exit {
      opacity: 0;
      transform: translateX(80%) scale(0.85);
      transition: opacity 0.4s ease-out, transform 0.4s ease-out;
    }

    /* –¶–≤–µ—Ç–∞ */
    .toast-gold {
      background: linear-gradient(135deg, rgba(36,28,12,0.96) 0%, rgba(22,18,8,0.98) 100%);
      border: 1px solid rgba(200,168,78,0.4);
    }
    
    .toast-blood {
      background: linear-gradient(135deg, rgba(36,12,12,0.96) 0%, rgba(22,8,8,0.98) 100%);
      border: 1px solid rgba(204,34,34,0.4);
    }
    
    .toast-mana {
      background: linear-gradient(135deg, rgba(12,22,36,0.96) 0%, rgba(8,16,26,0.98) 100%);
      border: 1px solid rgba(68,153,221,0.4);
    }
    
    .toast-green {
      background: linear-gradient(135deg, rgba(12,36,12,0.96) 0%, rgba(8,22,8,0.98) 100%);
      border: 1px solid rgba(68,204,68,0.4);
    }
    
    .toast-purple {
      background: linear-gradient(135deg, rgba(28,12,36,0.96) 0%, rgba(18,8,22,0.98) 100%);
      border: 1px solid rgba(150,80,220,0.4);
    }
    
    .toast-white {
      background: linear-gradient(135deg, rgba(28,28,32,0.96) 0%, rgba(18,18,22,0.98) 100%);
      border: 1px solid rgba(200,190,170,0.25);
    }

    /* –ö—Ä–∏—Ç */
    .toast-crit {
      border-color: var(--color-gold) !important;
      box-shadow: 0 8px 32px rgba(0,0,0,0.6), 0 0 40px rgba(232,208,104,0.3), inset 0 0 30px rgba(232,208,104,0.08) !important;
      animation: crit-entrance 0.7s ease-out;
    }
    
    @keyframes crit-entrance {
      0% { transform: translateX(150%) scale(0.4); filter: brightness(2.5); }
      40% { transform: translateX(-15px) scale(1.15); filter: brightness(1.8); }
      70% { transform: translateX(8px) scale(1.05); filter: brightness(1.2); }
      100% { transform: translateX(0) scale(1); filter: brightness(1); }
    }

    /* –ü—Ä–æ–≤–∞–ª */
    .toast-fail {
      border-color: var(--color-blood-bright) !important;
      animation: fail-entrance 0.5s ease-out;
    }
    
    @keyframes fail-entrance {
      0%, 100% { transform: translateX(0); }
      15% { transform: translateX(-8px); }
      30% { transform: translateX(6px); }
      45% { transform: translateX(-4px); }
      60% { transform: translateX(3px); }
      75% { transform: translateX(-1px); }
    }

    /* –ö—Ä–∏—Ç –ª—É—á–∏ */
    .crit-rays {
      position: absolute;
      inset: -300%;
      background: conic-gradient(from 0deg,
        transparent 0deg, rgba(232,208,104,0.1) 5deg, transparent 10deg,
        transparent 18deg, rgba(232,208,104,0.08) 23deg, transparent 28deg);
      animation: spin 10s linear infinite;
      pointer-events: none;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* –ö–æ–Ω—Ç–µ–Ω—Ç */
    .toast-content {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      position: relative;
      z-index: 2;
    }

    /* –ò–∫–æ–Ω–∫–∞ */
    .toast-icon {
      font-size: 28px;
      flex-shrink: 0;
      filter: drop-shadow(0 3px 6px rgba(0,0,0,0.5));
      animation: icon-pop 0.5s ease-out;
    }
    
    @keyframes icon-pop {
      0% { transform: scale(0) rotate(-60deg); opacity: 0; }
      60% { transform: scale(1.2) rotate(10deg); }
      100% { transform: scale(1) rotate(0); opacity: 1; }
    }
    
    .icon-crit {
      font-size: 34px;
      filter: drop-shadow(0 0 12px rgba(232,208,104,0.7));
      animation: icon-crit-pop 0.7s ease-out;
    }
    
    @keyframes icon-crit-pop {
      0% { transform: scale(0) rotate(-180deg); opacity: 0; }
      40% { transform: scale(1.4) rotate(25deg); }
      100% { transform: scale(1) rotate(0); opacity: 1; }
    }

    /* –¢–µ–ª–æ */
    .toast-body { flex: 1; min-width: 0; }
    
    .toast-unit {
      font-family: var(--font-cinzel);
      font-size: 10px;
      font-weight: 700;
      color: var(--color-faded);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-bottom: 2px;
    }
    
    .toast-title {
      font-family: var(--font-cinzel);
      font-size: 14px;
      font-weight: 700;
      color: var(--color-bone);
      line-height: 1.25;
    }
    
    .title-crit {
      color: var(--color-gold-bright) !important;
      text-shadow: 0 0 12px rgba(232,208,104,0.6);
      font-size: 16px;
    }
    
    .title-fail {
      color: var(--color-blood-bright) !important;
      text-shadow: 0 0 10px rgba(204,34,34,0.5);
    }
    
    .toast-subtitle {
      font-size: 12px;
      color: var(--color-ancient);
      font-style: italic;
      margin-top: 3px;
    }

    /* –ö—É–±–∏–∫–∏ */
    .toast-rolls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 5px;
      margin-top: 8px;
    }
    
    .die {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 26px;
      height: 26px;
      padding: 0 5px;
      border-radius: 5px;
      font-family: var(--font-cinzel);
      font-weight: 900;
      font-size: 12px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(200,190,170,0.2);
      color: var(--color-bone);
      animation: die-pop 0.35s ease-out forwards;
      animation-delay: calc(0.2s + var(--i, 0) * 0.06s);
      opacity: 0;
    }
    
    @keyframes die-pop {
      0% { opacity: 0; transform: scale(0) rotate(-30deg); }
      70% { transform: scale(1.15) rotate(5deg); }
      100% { opacity: 1; transform: scale(1) rotate(0); }
    }
    
    .die-crit {
      background: linear-gradient(135deg, rgba(200,168,78,0.4) 0%, rgba(200,168,78,0.2) 100%) !important;
      border-color: var(--color-gold) !important;
      color: var(--color-gold-bright) !important;
      box-shadow: 0 0 12px rgba(200,168,78,0.5);
    }
    
    .die-fail {
      background: rgba(204,34,34,0.3) !important;
      border-color: var(--color-blood-bright) !important;
      color: var(--color-blood-bright) !important;
    }
    
    .die-more {
      font-size: 11px;
      color: var(--color-faded);
      margin-left: 3px;
    }
    
    .total {
      font-family: var(--font-cinzel);
      font-size: 20px;
      font-weight: 900;
      color: var(--color-bone);
      text-shadow: 0 2px 4px rgba(0,0,0,0.6);
      margin-left: 8px;
    }
    
    .total-crit {
      color: var(--color-gold-bright) !important;
      text-shadow: 0 0 20px rgba(232,208,104,0.7);
      font-size: 24px;
    }
    
    .total-fail {
      color: var(--color-blood-bright) !important;
      text-shadow: 0 0 12px rgba(204,34,34,0.6);
    }

    /* –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–ø—Ä–∞–≤–∞ */
    .toast-result {
      font-family: var(--font-cinzel);
      font-size: 32px;
      font-weight: 900;
      color: var(--color-bone);
      text-shadow: 0 3px 6px rgba(0,0,0,0.6);
      flex-shrink: 0;
      animation: result-pop 0.6s ease-out;
    }
    
    @keyframes result-pop {
      0% { opacity: 0; transform: scale(0.2) rotate(-15deg); }
      40% { transform: scale(1.3) rotate(8deg); }
      100% { opacity: 1; transform: scale(1) rotate(0); }
    }
    
    .result-crit {
      color: var(--color-gold-bright) !important;
      text-shadow: 0 0 25px rgba(232,208,104,0.7);
      font-size: 38px;
    }

    /* HP –±–∞—Ä */
    .hp-bar {
      position: relative;
      height: 14px;
      border-radius: 7px;
      overflow: hidden;
      margin-top: 10px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .hp-fill {
      position: absolute;
      left: 0; top: 0; bottom: 0;
      border-radius: 7px;
      transition: width 0.7s ease;
    }
    
    .hp-damage { background: linear-gradient(90deg, #cc2222, #881414); }
    .hp-heal { background: linear-gradient(90deg, #22cc44, #118822); }
    
    .hp-text {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-cinzel);
      font-size: 10px;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 1px 4px rgba(0,0,0,0.9);
    }

    /* –î–µ—Ç–∞–ª–∏ */
    .toast-details {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    
    .detail-line {
      font-size: 11px;
      color: var(--color-faded);
      line-height: 1.45;
    }

    /* –ë–∞–Ω–Ω–µ—Ä */
    .toast-banner {
      text-align: center;
      font-family: var(--font-cinzel);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      padding: 8px 0 3px;
      margin-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .banner-crit {
      color: var(--color-gold-bright);
      text-shadow: 0 0 15px rgba(232,208,104,0.6);
      animation: banner-flash 1s ease-out;
    }
    
    @keyframes banner-flash {
      0% { opacity: 0; letter-spacing: 0.5em; }
      100% { opacity: 1; letter-spacing: 0.18em; }
    }
    
    .banner-fail {
      color: var(--color-blood-bright);
      text-shadow: 0 0 10px rgba(204,34,34,0.6);
    }

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å */
    .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--color-gold-dark), var(--color-gold));
      width: 100%;
      transform-origin: left;
      animation: progress-shrink 5s linear forwards;
      opacity: 0.6;
    }
    
    @keyframes progress-shrink {
      from { transform: scaleX(1); }
      to { transform: scaleX(0); }
    }
  </style>
</head>
<body>
  <div class="toast-container" id="container"></div>

  <script type="module">
    import OBR from "https://unpkg.com/@owlbear-rodeo/sdk@3.1.0/lib/index.js";

    const CHANNEL = "cursed-hearts/dice-roll";
    const AUTO_CLOSE = 5000;
    const MAX_TOASTS = 5;

    let toasts = new Map();

    function createToast(msg) {
      const toast = document.createElement('div');
      toast.className = `toast toast-enter toast-${msg.color || 'white'}`;
      
      if (msg.isCrit) {
        toast.classList.add('toast-crit');
        const rays = document.createElement('div');
        rays.className = 'crit-rays';
        toast.appendChild(rays);
      }
      
      if (msg.isCritFail) toast.classList.add('toast-fail');
      
      // –ö–æ–Ω—Ç–µ–Ω—Ç
      const content = document.createElement('div');
      content.className = 'toast-content';
      
      // –ò–∫–æ–Ω–∫–∞
      const icon = document.createElement('div');
      icon.className = 'toast-icon';
      if (msg.isCrit) icon.classList.add('icon-crit');
      icon.textContent = msg.icon || 'üé≤';
      content.appendChild(icon);
      
      // –¢–µ–ª–æ
      const body = document.createElement('div');
      body.className = 'toast-body';
      
      if (msg.unitName) {
        const unit = document.createElement('div');
        unit.className = 'toast-unit';
        unit.textContent = msg.unitName;
        body.appendChild(unit);
      }
      
      const title = document.createElement('div');
      title.className = 'toast-title';
      if (msg.isCrit) title.classList.add('title-crit');
      if (msg.isCritFail) title.classList.add('title-fail');
      title.textContent = msg.title;
      body.appendChild(title);
      
      if (msg.subtitle) {
        const sub = document.createElement('div');
        sub.className = 'toast-subtitle';
        sub.textContent = msg.subtitle;
        body.appendChild(sub);
      }
      
      // –ö—É–±–∏–∫–∏
      if (msg.rolls && msg.rolls.length > 0) {
        const rollsDiv = document.createElement('div');
        rollsDiv.className = 'toast-rolls';
        
        const show = msg.rolls.slice(0, 6);
        show.forEach((roll, i) => {
          const die = document.createElement('span');
          die.className = 'die';
          die.style.setProperty('--i', i);
          if (roll === 20) die.classList.add('die-crit');
          else if (roll === 1) die.classList.add('die-fail');
          die.textContent = roll;
          rollsDiv.appendChild(die);
        });
        
        if (msg.rolls.length > 6) {
          const more = document.createElement('span');
          more.className = 'die-more';
          more.textContent = `+${msg.rolls.length - 6}`;
          rollsDiv.appendChild(more);
        }
        
        if (msg.total !== undefined) {
          const total = document.createElement('span');
          total.className = 'total';
          if (msg.isCrit) total.classList.add('total-crit');
          if (msg.isCritFail) total.classList.add('total-fail');
          total.textContent = `= ${msg.total}`;
          rollsDiv.appendChild(total);
        }
        
        body.appendChild(rollsDiv);
      }
      
      content.appendChild(body);
      
      // –ë–æ–ª—å—à–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–ø—Ä–∞–≤–∞ –¥–ª—è —É—Ä–æ–Ω–∞
      if (msg.type === 'damage' && msg.total !== undefined) {
        const result = document.createElement('div');
        result.className = 'toast-result';
        if (msg.isCrit) result.classList.add('result-crit');
        result.textContent = msg.total;
        content.appendChild(result);
      }
      
      toast.appendChild(content);
      
      // HP –±–∞—Ä
      if (msg.hpBar) {
        const hp = document.createElement('div');
        hp.className = 'hp-bar';
        
        const fill = document.createElement('div');
        fill.className = `hp-fill ${msg.type === 'heal' ? 'hp-heal' : 'hp-damage'}`;
        fill.style.width = `${Math.max(0, Math.min(100, (msg.hpBar.current / msg.hpBar.max) * 100))}%`;
        hp.appendChild(fill);
        
        const text = document.createElement('div');
        text.className = 'hp-text';
        text.textContent = `${msg.hpBar.current}/${msg.hpBar.max}`;
        hp.appendChild(text);
        
        toast.appendChild(hp);
      }
      
      // –î–µ—Ç–∞–ª–∏
      if (msg.details && msg.details.length > 0) {
        const details = document.createElement('div');
        details.className = 'toast-details';
        msg.details.forEach(line => {
          const p = document.createElement('div');
          p.className = 'detail-line';
          p.textContent = line;
          details.appendChild(p);
        });
        toast.appendChild(details);
      }
      
      // –ë–∞–Ω–Ω–µ—Ä
      if (msg.isCrit || msg.isCritFail) {
        const banner = document.createElement('div');
        banner.className = `toast-banner ${msg.isCrit ? 'banner-crit' : 'banner-fail'}`;
        banner.textContent = msg.isCrit ? '‚ú® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–°–ü–ï–•! ‚ú®' : 'üíÄ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–û–í–ê–õ! üíÄ';
        toast.appendChild(banner);
      }
      
      // –ü—Ä–æ–≥—Ä–µ—Å—Å
      const progress = document.createElement('div');
      progress.className = 'toast-progress';
      toast.appendChild(progress);
      
      toast.addEventListener('click', () => removeToast(msg.id));
      
      return toast;
    }

    function addToast(msg) {
      if (toasts.size >= MAX_TOASTS) {
        const oldest = toasts.keys().next().value;
        if (oldest) removeToast(oldest);
      }
      
      const element = createToast(msg);
      document.getElementById('container').appendChild(element);
      
      requestAnimationFrame(() => {
        element.classList.remove('toast-enter');
        element.classList.add('toast-visible');
      });
      
      const timeoutId = setTimeout(() => removeToast(msg.id), AUTO_CLOSE);
      toasts.set(msg.id, { element, timeoutId });
    }

    function removeToast(id) {
      const toast = toasts.get(id);
      if (!toast) return;
      
      clearTimeout(toast.timeoutId);
      toast.element.classList.remove('toast-visible');
      toast.element.classList.add('toast-exit');
      
      setTimeout(() => {
        toast.element.remove();
        toasts.delete(id);
        
        if (toasts.size === 0) {
          setTimeout(() => {
            if (toasts.size === 0) {
              OBR.broadcast.sendMessage('cursed-hearts/close-toast', {});
            }
          }, 500);
        }
      }, 500);
    }

    OBR.onReady(() => {
      console.log('[Toast] Ready!');
      
      // –°–æ–æ–±—â–∞–µ–º —á—Ç–æ –≥–æ—Ç–æ–≤—ã
      OBR.broadcast.sendMessage('cursed-hearts/toast-ready', {});
      
      // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
      OBR.broadcast.onMessage(CHANNEL, (event) => {
        const msg = event.data;
        if (!msg || !msg.id) return;
        console.log('[Toast] Received:', msg.title);
        addToast(msg);
      });
    });
  </script>
</body>
</html>
