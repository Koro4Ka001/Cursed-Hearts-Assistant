<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dice Toast</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Cinzel+Decorative:wght@700&family=EB+Garamond:ital,wght@0,400;0,700;1,400&family=MedievalSharp&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-abyss: #0a0a0f;
      --color-dark: #111118;
      --color-obsidian: #1a1a24;
      --color-bone: #d4c8a8;
      --color-faded: #8a7e66;
      --color-dim: #5a5040;
      --color-gold: #c8a84e;
      --color-gold-bright: #e8d068;
      --color-gold-dark: #7a5a1e;
      --color-blood: #8b1a1a;
      --color-blood-bright: #cc2222;
      --color-mana-bright: #4499dd;
      --color-ancient: #7a6a4a;
      --font-cinzel: 'Cinzel', serif;
      --font-garamond: 'EB Garamond', serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-garamond);
      background: transparent;
      color: var(--color-bone);
      overflow: hidden;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ—Ö toast */
    .toast-overlay-root {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column-reverse;
      align-items: flex-end;
      justify-content: flex-start;
      padding: 8px;
      gap: 8px;
      pointer-events: none;
      overflow: hidden;
      background: transparent !important;
    }

    /* –í—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ —Å—Ç–∏–ª–∏ –¥–ª—è dice-toast –∏–∑ CSS */
    /* ... –∫–æ–ø–∏—Ä—É–µ–º —Å—Ç–∏–ª–∏ .dice-toast-card, .dt-*, –∞–Ω–∏–º–∞—Ü–∏–∏ ... */
    
    /* –Ø –≤—Å—Ç–∞–≤–ª—é —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≤–æ–∑—å–º—ë–º –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ CSS */
    .dice-toast-card {
      width: 100%;
      max-width: 340px;
      border-radius: 14px;
      padding: 12px 16px;
      position: relative;
      overflow: hidden;
      pointer-events: auto;
      cursor: pointer;
      backdrop-filter: blur(20px);
      transform-origin: right bottom;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 2px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.08);
      transition: transform 0.2s;
    }

    .dice-toast-card:hover {
      transform: scale(1.02) translateX(-4px);
    }

    /* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏–∑ CSS —Ñ–∞–π–ª–∞ ... */
  </style>
</head>
<body>
  <div class="toast-overlay-root" id="toast-container"></div>

  <script type="module">
    import OBR from "https://unpkg.com/@owlbear-rodeo/sdk@3.1.0/lib/index.js";

    const DICE_BROADCAST_CHANNEL = "cursed-hearts/dice-roll";
    const AUTO_CLOSE_DELAY = 5000;
    const MAX_TOASTS = 5;

    let toasts = new Map(); // id -> {element, timeoutId}

    // –°–æ–∑–¥–∞–Ω–∏–µ toast —ç–ª–µ–º–µ–Ω—Ç–∞
    function createToast(msg) {
      const toast = document.createElement('div');
      toast.className = 'dice-toast-card dt-enter';
      
      // –¶–≤–µ—Ç
      const colorClass = `dt-${msg.color || 'white'}`;
      toast.classList.add(colorClass);
      
      // –ö—Ä–∏—Ç/—Ñ–µ–π–ª
      if (msg.isCrit) {
        toast.classList.add('dt-crit');
        // –ö—Ä–∏—Ç –ª—É—á–∏
        const rays = document.createElement('div');
        rays.className = 'dt-crit-rays';
        toast.appendChild(rays);
      }
      if (msg.isCritFail) {
        toast.classList.add('dt-fail');
        // –¢—Ä–µ—â–∏–Ω—ã
        const cracks = document.createElement('div');
        cracks.className = 'dt-fail-cracks';
        toast.appendChild(cracks);
      }
      
      // –°–≤–µ—á–µ–Ω–∏–µ
      const glow = document.createElement('div');
      glow.className = 'dt-glow';
      toast.appendChild(glow);
      
      // –ö–æ–Ω—Ç–µ–Ω—Ç
      const content = document.createElement('div');
      content.className = 'dt-content';
      
      // –ò–∫–æ–Ω–∫–∞
      const icon = document.createElement('div');
      icon.className = 'dt-icon';
      if (msg.isCrit) icon.classList.add('dt-icon-crit');
      if (msg.isCritFail) icon.classList.add('dt-icon-fail');
      icon.textContent = msg.icon || 'üé≤';
      content.appendChild(icon);
      
      // –¢–µ–ª–æ
      const body = document.createElement('div');
      body.className = 'dt-body';
      
      // –ò–º—è —é–Ω–∏—Ç–∞
      if (msg.unitName) {
        const unit = document.createElement('div');
        unit.className = 'dt-unit';
        unit.textContent = msg.unitName;
        body.appendChild(unit);
      }
      
      // –ó–∞–≥–æ–ª–æ–≤–æ–∫
      const title = document.createElement('div');
      title.className = 'dt-title';
      if (msg.isCrit) title.classList.add('dt-title-crit');
      if (msg.isCritFail) title.classList.add('dt-title-fail');
      title.textContent = msg.title;
      body.appendChild(title);
      
      // –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫
      if (msg.subtitle) {
        const subtitle = document.createElement('div');
        subtitle.className = 'dt-subtitle';
        subtitle.textContent = msg.subtitle;
        body.appendChild(subtitle);
      }
      
      // –ö—É–±–∏–∫–∏
      if (msg.rolls && msg.rolls.length > 0) {
        const rollsDiv = document.createElement('div');
        rollsDiv.className = 'dt-rolls';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ 6 –∫—É–±–∏–∫–æ–≤
        const showRolls = msg.rolls.slice(0, 6);
        const hasMore = msg.rolls.length > 6;
        
        showRolls.forEach((roll, i) => {
          const die = document.createElement('span');
          die.className = 'dt-die';
          die.style.setProperty('--die-i', i);
          
          if (roll === 20) die.classList.add('dt-die-crit');
          else if (roll === 1) die.classList.add('dt-die-fail');
          
          die.textContent = roll;
          rollsDiv.appendChild(die);
        });
        
        if (hasMore) {
          const more = document.createElement('span');
          more.className = 'dt-die-more';
          more.textContent = `+${msg.rolls.length - 6}`;
          rollsDiv.appendChild(more);
        }
        
        if (msg.total !== undefined) {
          const eq = document.createElement('span');
          eq.className = 'dt-eq';
          eq.textContent = '=';
          rollsDiv.appendChild(eq);
          
          const total = document.createElement('span');
          total.className = 'dt-total';
          if (msg.isCrit) total.classList.add('dt-total-crit');
          if (msg.isCritFail) total.classList.add('dt-total-fail');
          total.textContent = msg.total;
          rollsDiv.appendChild(total);
        }
        
        body.appendChild(rollsDiv);
      }
      
      content.appendChild(body);
      
      // –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–ø—Ä–∞–≤–∞ (–±–æ–ª—å—à–æ–π)
      if (msg.total !== undefined && msg.type === 'damage') {
        const result = document.createElement('div');
        result.className = 'dt-result';
        if (msg.isCrit) result.classList.add('dt-result-crit');
        if (msg.isCritFail) result.classList.add('dt-result-fail');
        result.textContent = msg.total;
        content.appendChild(result);
      }
      
      toast.appendChild(content);
      
      // HP –±–∞—Ä
      if (msg.hpBar) {
        const hp = document.createElement('div');
        hp.className = 'dt-hp';
        
        const fill = document.createElement('div');
        fill.className = 'dt-hp-fill';
        fill.classList.add(msg.type === 'heal' ? 'dt-hp-heal' : 'dt-hp-dmg');
        const percent = Math.max(0, Math.min(100, (msg.hpBar.current / msg.hpBar.max) * 100));
        fill.style.width = `${percent}%`;
        hp.appendChild(fill);
        
        const text = document.createElement('div');
        text.className = 'dt-hp-txt';
        text.textContent = `${msg.hpBar.current}/${msg.hpBar.max}`;
        hp.appendChild(text);
        
        toast.appendChild(hp);
      }
      
      // –î–µ—Ç–∞–ª–∏
      if (msg.details && msg.details.length > 0) {
        const details = document.createElement('div');
        details.className = 'dt-details';
        
        msg.details.forEach((line, i) => {
          const detailLine = document.createElement('div');
          detailLine.className = 'dt-detail-line';
          detailLine.style.setProperty('--line-index', i);
          detailLine.textContent = line;
          details.appendChild(detailLine);
        });
        
        toast.appendChild(details);
      }
      
      // –ë–∞–Ω–Ω–µ—Ä (–∫—Ä–∏—Ç/—Ñ–µ–π–ª)
      if (msg.isCrit || msg.isCritFail) {
        const banner = document.createElement('div');
        banner.className = 'dt-banner';
        banner.classList.add(msg.isCrit ? 'dt-banner-crit' : 'dt-banner-fail');
        banner.textContent = msg.isCrit ? '‚ú® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–°–ü–ï–•! ‚ú®' : 'üíÄ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–û–í–ê–õ! üíÄ';
        toast.appendChild(banner);
      }
      
      // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
      const progress = document.createElement('div');
      progress.className = 'dt-progress';
      toast.appendChild(progress);
      
      // –ö–ª–∏–∫ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç
      toast.addEventListener('click', () => {
        removeToast(msg.id);
      });
      
      return toast;
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ toast
    function addToast(msg) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
      if (toasts.size >= MAX_TOASTS) {
        // –£–¥–∞–ª—è–µ–º —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π
        const oldestId = toasts.keys().next().value;
        if (oldestId) removeToast(oldestId);
      }
      
      const element = createToast(msg);
      const container = document.getElementById('toast-container');
      container.appendChild(element);
      
      // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
      requestAnimationFrame(() => {
        element.classList.remove('dt-enter');
        element.classList.add('dt-visible');
      });
      
      // –ê–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ
      const timeoutId = setTimeout(() => {
        removeToast(msg.id);
      }, AUTO_CLOSE_DELAY);
      
      toasts.set(msg.id, { element, timeoutId });
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ toast
    function removeToast(id) {
      const toast = toasts.get(id);
      if (!toast) return;
      
      clearTimeout(toast.timeoutId);
      
      // –ê–Ω–∏–º–∞—Ü–∏—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
      toast.element.classList.remove('dt-visible');
      toast.element.classList.add('dt-exit');
      
      setTimeout(() => {
        toast.element.remove();
        toasts.delete(id);
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –±–æ–ª—å—à–µ —Å–æ–æ–±—â–µ–Ω–∏–π - –∑–∞–∫—Ä—ã–≤–∞–µ–º popover
        if (toasts.size === 0) {
          setTimeout(() => {
            if (toasts.size === 0) {
              OBR.broadcast.sendMessage('cursed-hearts/close-toast', {});
            }
          }, 500);
        }
      }, 500);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    OBR.onReady(() => {
      console.log('[Toast] Ready to receive messages');
      
      // –°–æ–æ–±—â–∞–µ–º —á—Ç–æ –≥–æ—Ç–æ–≤—ã
      OBR.broadcast.sendMessage('cursed-hearts/toast-ready', {});
      
      // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
      OBR.broadcast.onMessage(DICE_BROADCAST_CHANNEL, (event) => {
        const msg = event.data;
        if (!msg || !msg.id) return;
        
        console.log('[Toast] Received:', msg.title);
        addToast(msg);
      });
    });
  </script>
</body>
</html>
