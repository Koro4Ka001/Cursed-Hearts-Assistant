<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dice Toast</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=EB+Garamond:ital@0;1&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --gold: #c8a84e;
      --gold-bright: #e8d068;
      --gold-dark: #7a5a1e;
      --blood: #8b1a1a;
      --blood-bright: #cc2222;
      --mana: #4499dd;
      --bone: #d4c8a8;
      --faded: #8a7e66;
      --dim: #5a5040;
      --bg: #0a0a0f;
    }
    
    html, body {
      height: 100%;
      background: var(--bg);
      overflow: hidden;
      font-family: 'EB Garamond', serif;
    }
    
    /* –ö—Ä–∞—Å–∏–≤–∞—è —Ä–∞–º–∫–∞ –≤–º–µ—Å—Ç–æ —Å–µ—Ä–æ–π */
    body {
      border: 1px solid rgba(200,168,78,0.3);
      border-radius: 8px;
      box-shadow: 
        inset 0 0 30px rgba(0,0,0,0.8),
        0 0 20px rgba(0,0,0,0.5);
      background: 
        radial-gradient(ellipse at top right, rgba(200,168,78,0.05) 0%, transparent 50%),
        radial-gradient(ellipse at bottom left, rgba(139,26,26,0.03) 0%, transparent 50%),
        var(--bg);
    }
    
    /* –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —É–≥–æ–ª–∫–∏ */
    body::before, body::after {
      content: '‚óÜ';
      position: absolute;
      font-size: 8px;
      color: var(--gold-dark);
      opacity: 0.5;
    }
    body::before { top: 6px; left: 8px; }
    body::after { bottom: 6px; right: 8px; }
    
    #container {
      position: absolute;
      bottom: 8px;
      right: 8px;
      left: 8px;
      top: 8px;
      display: flex;
      flex-direction: column-reverse;
      gap: 6px;
      pointer-events: none;
      overflow: hidden;
    }
    
    /* ‚ïê‚ïê‚ïê Toast Card ‚ïê‚ïê‚ïê */
    .toast {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 8px;
      pointer-events: auto;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transform-origin: right bottom;
      opacity: 0;
      transform: translateX(100%) scale(0.8);
      transition: opacity 0.4s, transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .toast.visible {
      opacity: 1;
      transform: translateX(0) scale(1);
    }
    
    .toast.exit {
      opacity: 0;
      transform: translateX(80%) scale(0.9);
      transition: opacity 0.3s, transform 0.3s ease-out;
    }
    
    .toast:hover {
      transform: translateX(-4px) scale(1.02) !important;
    }
    
    /* ‚ïê‚ïê‚ïê Colors ‚ïê‚ïê‚ïê */
    .toast-gold {
      background: linear-gradient(145deg, rgba(40,32,14,0.98), rgba(24,20,10,0.99));
      border: 1px solid rgba(200,168,78,0.5);
      box-shadow: 0 4px 16px rgba(0,0,0,0.4), 0 0 20px rgba(200,168,78,0.1);
    }
    
    .toast-blood {
      background: linear-gradient(145deg, rgba(40,14,14,0.98), rgba(24,10,10,0.99));
      border: 1px solid rgba(204,34,34,0.5);
      box-shadow: 0 4px 16px rgba(0,0,0,0.4), 0 0 15px rgba(204,34,34,0.1);
    }
    
    .toast-mana {
      background: linear-gradient(145deg, rgba(14,24,40,0.98), rgba(10,18,28,0.99));
      border: 1px solid rgba(68,153,221,0.5);
      box-shadow: 0 4px 16px rgba(0,0,0,0.4), 0 0 15px rgba(68,153,221,0.1);
    }
    
    .toast-green {
      background: linear-gradient(145deg, rgba(14,40,14,0.98), rgba(10,24,10,0.99));
      border: 1px solid rgba(68,204,68,0.5);
      box-shadow: 0 4px 16px rgba(0,0,0,0.4), 0 0 15px rgba(68,204,68,0.1);
    }
    
    .toast-purple {
      background: linear-gradient(145deg, rgba(32,14,40,0.98), rgba(20,10,26,0.99));
      border: 1px solid rgba(150,80,220,0.5);
      box-shadow: 0 4px 16px rgba(0,0,0,0.4), 0 0 15px rgba(150,80,220,0.1);
    }
    
    .toast-white {
      background: linear-gradient(145deg, rgba(32,32,36,0.98), rgba(20,20,24,0.99));
      border: 1px solid rgba(200,190,170,0.3);
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    }
    
    /* ‚ïê‚ïê‚ïê Crit Effects ‚ïê‚ïê‚ïê */
    .toast-crit {
      border-color: var(--gold) !important;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4), 0 0 30px rgba(232,208,104,0.25) !important;
      animation: crit-entrance 0.6s ease-out;
    }
    
    @keyframes crit-entrance {
      0% { transform: translateX(120%) scale(0.4); filter: brightness(2.5); }
      50% { transform: translateX(-8px) scale(1.1); filter: brightness(1.5); }
      100% { transform: translateX(0) scale(1); filter: brightness(1); }
    }
    
    .toast-crit::before {
      content: '';
      position: absolute;
      inset: -150%;
      background: conic-gradient(from 0deg, transparent, rgba(232,208,104,0.08) 5deg, transparent 10deg, transparent 20deg, rgba(232,208,104,0.06) 25deg, transparent 30deg);
      animation: rays-spin 8s linear infinite;
      pointer-events: none;
    }
    
    @keyframes rays-spin { to { transform: rotate(360deg); } }
    
    /* ‚ïê‚ïê‚ïê Fail Effects ‚ïê‚ïê‚ïê */
    .toast-fail {
      border-color: var(--blood-bright) !important;
      animation: fail-shake 0.5s ease-out;
    }
    
    @keyframes fail-shake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-6px); }
      40% { transform: translateX(6px); }
      60% { transform: translateX(-4px); }
      80% { transform: translateX(2px); }
    }
    
    /* ‚ïê‚ïê‚ïê Icon ‚ïê‚ïê‚ïê */
    .toast-icon {
      font-size: 24px;
      flex-shrink: 0;
      line-height: 1;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
      animation: icon-pop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s both;
    }
    
    @keyframes icon-pop {
      0% { transform: scale(0) rotate(-45deg); opacity: 0; }
      100% { transform: scale(1) rotate(0); opacity: 1; }
    }
    
    .toast-crit .toast-icon {
      font-size: 28px;
      filter: drop-shadow(0 0 10px rgba(232,208,104,0.8));
    }
    
    /* ‚ïê‚ïê‚ïê Body ‚ïê‚ïê‚ïê */
    .toast-body { flex: 1; min-width: 0; }
    
    .toast-unit {
      font-family: 'Cinzel', serif;
      font-size: 9px;
      font-weight: 700;
      color: var(--faded);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 1px;
    }
    
    .toast-title {
      font-family: 'Cinzel', serif;
      font-size: 12px;
      font-weight: 700;
      color: var(--bone);
      line-height: 1.2;
    }
    
    .toast-crit .toast-title {
      color: var(--gold-bright);
      text-shadow: 0 0 10px rgba(232,208,104,0.6);
      font-size: 13px;
    }
    
    .toast-fail .toast-title {
      color: var(--blood-bright);
      text-shadow: 0 0 8px rgba(204,34,34,0.5);
    }
    
    .toast-subtitle {
      font-size: 10px;
      color: var(--faded);
      font-style: italic;
      margin-top: 2px;
    }
    
    /* ‚ïê‚ïê‚ïê Dice ‚ïê‚ïê‚ïê */
    .toast-rolls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 4px;
      margin-top: 5px;
    }
    
    .toast-die {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 22px;
      height: 22px;
      padding: 0 4px;
      border-radius: 4px;
      font-family: 'Cinzel', serif;
      font-weight: 900;
      font-size: 11px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(200,190,170,0.2);
      color: var(--bone);
      animation: die-pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) both;
    }
    
    .toast-die:nth-child(1) { animation-delay: 0.15s; }
    .toast-die:nth-child(2) { animation-delay: 0.2s; }
    .toast-die:nth-child(3) { animation-delay: 0.25s; }
    .toast-die:nth-child(4) { animation-delay: 0.3s; }
    
    @keyframes die-pop {
      0% { opacity: 0; transform: scale(0) rotate(-30deg); }
      100% { opacity: 1; transform: scale(1) rotate(0); }
    }
    
    .toast-die-crit {
      background: linear-gradient(135deg, rgba(200,168,78,0.4), rgba(200,168,78,0.2)) !important;
      border-color: var(--gold) !important;
      color: var(--gold-bright) !important;
      box-shadow: 0 0 8px rgba(200,168,78,0.5);
    }
    
    .toast-die-fail {
      background: rgba(204,34,34,0.3) !important;
      border-color: var(--blood-bright) !important;
      color: var(--blood-bright) !important;
    }
    
    .toast-eq {
      color: var(--dim);
      font-size: 12px;
      margin: 0 2px;
    }
    
    .toast-total {
      font-family: 'Cinzel', serif;
      font-size: 16px;
      font-weight: 900;
      color: var(--bone);
      text-shadow: 0 2px 4px rgba(0,0,0,0.6);
      animation: total-pop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) 0.4s both;
    }
    
    @keyframes total-pop {
      0% { opacity: 0; transform: scale(0.3); }
      60% { transform: scale(1.2); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    .toast-crit .toast-total {
      color: var(--gold-bright) !important;
      text-shadow: 0 0 12px rgba(232,208,104,0.7);
      font-size: 20px;
    }
    
    .toast-fail .toast-total {
      color: var(--blood-bright) !important;
    }
    
    /* ‚ïê‚ïê‚ïê HP Bar ‚ïê‚ïê‚ïê */
    .toast-hp {
      position: relative;
      height: 10px;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 6px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .toast-hp-fill {
      position: absolute;
      left: 0; top: 0; bottom: 0;
      border-radius: 5px;
      transition: width 0.5s ease;
    }
    
    .toast-hp-dmg { background: linear-gradient(90deg, #cc2222, #881414); }
    .toast-hp-heal { background: linear-gradient(90deg, #22cc44, #118822); }
    
    .toast-hp-txt {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Cinzel', serif;
      font-size: 8px;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 1px 2px rgba(0,0,0,0.9);
    }
    
    /* ‚ïê‚ïê‚ïê Banner ‚ïê‚ïê‚ïê */
    .toast-banner {
      text-align: center;
      font-family: 'Cinzel', serif;
      font-size: 8px;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 5px 0 2px;
      margin-top: 6px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .toast-banner-crit {
      color: var(--gold-bright);
      text-shadow: 0 0 10px rgba(232,208,104,0.7);
    }
    
    .toast-banner-fail {
      color: var(--blood-bright);
      text-shadow: 0 0 8px rgba(204,34,34,0.6);
    }
    
    /* ‚ïê‚ïê‚ïê Progress Bar ‚ïê‚ïê‚ïê */
    .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--gold-dark), var(--gold));
      width: 100%;
      transform-origin: left;
      animation: progress-shrink 4s linear forwards;
      opacity: 0.5;
    }
    
    @keyframes progress-shrink { from { transform: scaleX(1); } to { transform: scaleX(0); } }
    
    .toast-crit .toast-progress {
      background: linear-gradient(90deg, var(--gold), var(--gold-bright));
      opacity: 0.8;
      height: 3px;
    }
    
    .toast-fail .toast-progress {
      background: linear-gradient(90deg, var(--blood), var(--blood-bright));
    }
    
    /* ‚ïê‚ïê‚ïê Empty State ‚ïê‚ïê‚ïê */
    #empty {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: var(--dim);
      font-family: 'Cinzel', serif;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      opacity: 0.5;
    }
    
    #empty.show {
      display: flex;
    }
    
    #empty span {
      font-size: 24px;
      margin-bottom: 8px;
      opacity: 0.3;
    }
  </style>
</head>
<body>
  <div id="container"></div>
  <div id="empty"><span>üé≤</span>–û–∂–∏–¥–∞–Ω–∏–µ –±—Ä–æ—Å–∫–æ–≤...</div>
  
  <script src="https://cdn.jsdelivr.net/npm/@owlbear-rodeo/sdk@3.1.0/dist/owlbear-rodeo-sdk.umd.min.js"></script>
  <script>
    const CHANNEL = 'cursed-hearts/dice-roll';
    const CLOSE_CHANNEL = 'cursed-hearts/close-toast';
    const POPOVER_ID = 'cursed-hearts-dice-toast';
    const container = document.getElementById('container');
    const emptyState = document.getElementById('empty');
    const DURATION = 4000;
    const CLOSE_DELAY = 2000; // –ó–∞–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 2 —Å–µ–∫ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ toast
    const MAX_TOASTS = 4;
    const processedIds = new Set();
    let closeTimer = null;
    
    const ICONS = {
      roll: 'üé≤', damage: 'üí•', hit: 'üéØ', miss: 'üí®',
      spell: '‚ú®', heal: 'üíö', death: '‚ò†Ô∏è', 'rok-card': 'üÉè', custom: 'üì¢'
    };
    
    function updateEmptyState() {
      if (container.children.length === 0) {
        emptyState.classList.add('show');
        scheduleClose();
      } else {
        emptyState.classList.remove('show');
        cancelClose();
      }
    }
    
    function scheduleClose() {
      cancelClose();
      closeTimer = setTimeout(() => {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –∑–∞–∫—Ä—ã—Ç—å popover
        OBR.broadcast.sendMessage(CLOSE_CHANNEL, { close: true }).catch(() => {});
        // –¢–∞–∫–∂–µ –ø—Ä–æ–±—É–µ–º –∑–∞–∫—Ä—ã—Ç—å –Ω–∞–ø—Ä—è–º—É—é
        OBR.popover.close(POPOVER_ID).catch(() => {});
      }, CLOSE_DELAY);
    }
    
    function cancelClose() {
      if (closeTimer) {
        clearTimeout(closeTimer);
        closeTimer = null;
      }
    }
    
    function createToast(msg) {
      if (processedIds.has(msg.id)) return;
      processedIds.add(msg.id);
      
      if (processedIds.size > 30) {
        const arr = Array.from(processedIds);
        processedIds.clear();
        arr.slice(-15).forEach(id => processedIds.add(id));
      }
      
      while (container.children.length >= MAX_TOASTS) {
        container.removeChild(container.lastChild);
      }
      
      const colorClass = 'toast-' + (msg.color || 'white');
      const isCrit = msg.isCrit;
      const isFail = msg.isCritFail;
      
      const el = document.createElement('div');
      el.className = 'toast ' + colorClass + (isCrit ? ' toast-crit' : '') + (isFail ? ' toast-fail' : '');
      
      let icon = msg.icon || ICONS[msg.type] || 'üé≤';
      if (isCrit) icon = '‚ú®';
      if (isFail) icon = 'üíÄ';
      
      let html = '<span class="toast-icon">' + icon + '</span>';
      html += '<div class="toast-body">';
      
      if (msg.unitName) {
        html += '<div class="toast-unit">' + esc(msg.unitName) + '</div>';
      }
      
      html += '<div class="toast-title">' + esc(msg.title) + '</div>';
      
      if (msg.subtitle) {
        html += '<div class="toast-subtitle">' + esc(msg.subtitle) + '</div>';
      }
      
      if (msg.rolls && msg.rolls.length > 0) {
        html += '<div class="toast-rolls">';
        const max = Math.min(msg.rolls.length, 4);
        for (let i = 0; i < max; i++) {
          const r = msg.rolls[i];
          let cls = 'toast-die';
          if (i === 0 && r === 20) cls += ' toast-die-crit';
          if (i === 0 && r === 1) cls += ' toast-die-fail';
          html += '<span class="' + cls + '">' + r + '</span>';
        }
        if (msg.rolls.length > 4) {
          html += '<span class="toast-die">+' + (msg.rolls.length - 4) + '</span>';
        }
        if (msg.total !== undefined) {
          html += '<span class="toast-eq">=</span>';
          html += '<span class="toast-total">' + msg.total + '</span>';
        }
        html += '</div>';
      }
      
      if (msg.hpBar) {
        const pct = Math.max(0, Math.min(100, (msg.hpBar.current / msg.hpBar.max) * 100));
        const fill = msg.type === 'heal' ? 'toast-hp-heal' : 'toast-hp-dmg';
        html += '<div class="toast-hp">';
        html += '<div class="toast-hp-fill ' + fill + '" style="width:' + pct + '%"></div>';
        html += '<span class="toast-hp-txt">' + msg.hpBar.current + '/' + msg.hpBar.max + '</span>';
        html += '</div>';
      }
      
      html += '</div>';
      
      if (isCrit) html += '<div class="toast-banner toast-banner-crit">‚ú® –ö–†–ò–¢ ‚ú®</div>';
      if (isFail) html += '<div class="toast-banner toast-banner-fail">üíÄ –ü–†–û–í–ê–õ</div>';
      
      html += '<div class="toast-progress"></div>';
      
      el.innerHTML = html;
      container.insertBefore(el, container.firstChild);
      updateEmptyState();
      
      requestAnimationFrame(() => {
        setTimeout(() => el.classList.add('visible'), 10);
      });
      
      el.onclick = () => remove(el);
      setTimeout(() => remove(el), DURATION);
    }
    
    function remove(el) {
      if (!el || el.classList.contains('exit')) return;
      el.classList.remove('visible');
      el.classList.add('exit');
      setTimeout(() => {
        if (el.parentNode) el.remove();
        updateEmptyState();
      }, 350);
    }
    
    function esc(s) {
      if (!s) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
    
    // Init
    updateEmptyState();
    
    OBR.onReady(() => {
      console.log('[Toast] Ready, listening to:', CHANNEL);
      
      OBR.broadcast.onMessage(CHANNEL, (e) => {
        console.log('[Toast] Received:', e.data);
        if (e.data && e.data.id) createToast(e.data);
      });
    });
  </script>
</body>
</html>
